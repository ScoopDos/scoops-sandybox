name: Discord Commit Embed

on:
  push:
    branches:
      - main
      - dev

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # full history for accurate commit count

      - name: Format commit and send embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Extract commit title and body
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_TITLE=$(echo "$COMMIT_MESSAGE" | head -n1)
          COMMIT_BODY_RAW=$(echo "$COMMIT_MESSAGE" | tail -n +2)

          # Format changed files with emojis and full labels
          FILES=$(git diff --name-status HEAD~1 HEAD | sed 's/\t/ /g')
          FORMATTED=""
          while read -r line; do
            STATUS=$(echo "$line" | cut -d' ' -f1)
            FILE=$(echo "$line" | cut -d' ' -f2-)
            case "$STATUS" in
              A) LABEL="🟩 **Added:**" ;;
              M) LABEL="🟨 **Modified:**" ;;
              D) LABEL="🟥 **Deleted:**" ;;
              *) LABEL="🔧 **Changed:**" ;;
            esac
            FORMATTED="$FORMATTED\\n• $LABEL $FILE"
          done <<< "$FILES"

          # Map repo name to display name
          REPO_RAW="${{ github.event.repository.name }}"
          case "$REPO_RAW" in
            scoop) DISPLAY_NAME="Scoop" ;;
            scoops-sandbox) DISPLAY_NAME="Scoop-FiveM" ;;
            scoops-sandybox) DISPLAY_NAME="Scoop-S&Box" ;;
            *) DISPLAY_NAME="$REPO_RAW" ;;
          esac

          # Generate version from commit count
          VERSION=$(git rev-list --count HEAD)
          VERSION_LABEL="v0.0.$VERSION"

          # Conditionally build description
          if [ -n "$COMMIT_BODY_RAW" ]; then
            COMMIT_BODY=$(echo "$COMMIT_BODY_RAW" | sed ':a;N;$!ba;s/\n/\\n/g')
            DESCRIPTION="$COMMIT_TITLE\\n\\n$COMMIT_BODY\\n\\n**Files Changed:**$FORMATTED"
          else
            DESCRIPTION="$COMMIT_TITLE\\n\\n**Files Changed:**$FORMATTED"
          fi

          # Build and send embed
          echo "{
            \"username\": \"Scoop Update Bot\",
            \"embeds\": [{
              \"title\": \"🛠️ $DISPLAY_NAME ($VERSION_LABEL)\",
              \"description\": \"$DESCRIPTION\",
              \"url\": \"${{ github.event.head_commit.url }}\",
              \"color\": 5814783,
              \"fields\": [
                {
                  \"name\": \"Author\",
                  \"value\": \"${{ github.actor }}\",
                  \"inline\": true
                },
                {
                  \"name\": \"Branch\",
                  \"value\": \"${{ github.ref_name }}\",
                  \"inline\": true
                }
              ],
              \"footer\": {
                \"text\": \"Scoop's Projects\"
              },
              \"timestamp\": \"${{ github.event.head_commit.timestamp }}\"
            }]
          }" > payload.json

          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
